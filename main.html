<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Main</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --dark-green: #1a3c2a;
      --light-green: #2d6646;
      --accent: #4CAF50;
      --text: #e0e0e0;
      --dark-bg: #0a1f15;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Consolas', monospace;
      background-color: var(--dark-green);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #landing {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .subtitle {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 2rem;
    }

    .input-container {
      max-width: 600px;
      width: 90%;
      position: relative;
      margin-bottom: 1rem; /* Reduced margin */
    }

    #url-input {
      width: 100%;
      padding: 14px 20px;
      font-size: 1rem;
      background-color: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--light-green);
      border-radius: 6px;
      color: var(--text);
      outline: none;
      transition: all 0.3s;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    #url-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
    }

    .go-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }

    .go-btn:hover {
      background-color: #3e8e41;
    }

    .settings-container {
      max-width: 600px;
      width: 90%;
      margin: 0 auto;
      margin-bottom: 2rem;
      text-align: center;
    }

    .settings-btn {
      background-color: var(--light-green);
      color: var(--text);
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .settings-btn:hover {
      background-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .option-container {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 1rem;
    }
    
    .options {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1.5rem;
    }
    
    .option-box {
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--light-green);
      border-radius: 8px;
      padding: 25px;
      width: 180px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .option-box:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .option-box i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--accent);
    }

    footer {
      padding: 15px;
      text-align: center;
      font-size: 0.8rem;
      color: rgba(224, 224, 224, 0.7);
      background-color: rgba(0,0,0,0.2);
      transition: opacity 0.3s ease;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    #content-view {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
    }

    #loading-screen {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10;
    }

    .loader {
      border: 5px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top: 5px solid var(--accent);
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .method-label {
      font-size: 0.8rem;
      color: var(--text);
      margin-top: 8px;
      opacity: 0.8;
      text-align: center;
    }

    #method-switch {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: var(--dark-bg);
      color: var(--text);
      border: 1px solid var(--light-green);
      border-radius: 4px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    #method-switch.show-dropdown .switch-box,
    #method-switch:hover .switch-box {
      display: flex;
      opacity: 1;
    }

    #method-switch:hover,
    #method-switch.show-dropdown {
      opacity: 1 !important;
      background-color: var(--light-green);
    }

    .method-switch-area {
      position: fixed;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      z-index: 998;
    }
    
    .method-switch-area:hover #method-switch {
      opacity: 0.7;
    }

    .switch-box {
      display: none;
      position: absolute;
      top: 45px;
      right: 0;
      background-color: var(--dark-bg);
      border: 1px solid var(--light-green);
      border-radius: 4px;
      padding: 10px;
      flex-direction: column;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      min-width: 180px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .switch-btn {
      padding: 5px 10px;
      background-color: var(--light-green);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px 0;
      transition: background-color 0.2s;
    }

    .switch-btn:hover {
      background-color: var(--accent);
    }

    .corner-icon {
      font-size: 1.5rem;
      color: var(--accent);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .back-btn-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 80px;
      height: 80px;
      z-index: 9998;
      display: none;
    }
    
    .back-btn-area:hover #back-btn {
      opacity: 0.7;
    }

    #back-btn {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background-color: var(--dark-bg);
      color: var(--text);
      border: 1px solid var(--light-green);
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
    }

    #back-btn:hover {
      opacity: 1 !important;
      background-color: var(--light-green);
    }
    
    .next-method-btn {
      margin-top: 15px;
      padding: 8px 15px;
      background-color: var(--light-green);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: bold;
    }

    .next-method-btn:hover {
      background-color: var(--accent);
    }
    
    .loading-info {
      text-align: center;
      margin-top: 10px;
      font-size: 0.9em;
      opacity: 0.8;
    }
    
    /* New styles for the sources management */
    .sources-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .sources-container {
      background-color: var(--dark-bg);
      border: 1px solid var(--light-green);
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .sources-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--light-green);
      padding-bottom: 10px;
    }
    
    .sources-close {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .sources-close:hover {
      color: var(--accent);
    }
    
    .source-item {
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--light-green);
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .source-item:hover {
      border-color: var(--accent);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    
    .source-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .source-title {
      font-size: 1.1rem;
      font-weight: bold;
    }
    
    .source-toggle {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .source-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #444;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--accent);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    .source-speed {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 5px;
    }
    
    .speed-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #444;
    }
    
    .speed-fast .speed-dot:nth-child(1),
    .speed-fast .speed-dot:nth-child(2),
    .speed-fast .speed-dot:nth-child(3) {
      background-color: #4CAF50;
    }
    
    .speed-medium .speed-dot:nth-child(1),
    .speed-medium .speed-dot:nth-child(2) {
      background-color: #FFC107;
    }
    
    .speed-slow .speed-dot:nth-child(1) {
      background-color: #F44336;
    }
    
    .source-description {
      font-size: 0.9rem;
      margin: 10px 0;
      line-height: 1.4;
      opacity: 0.9;
    }
    
    .add-source-section {
      margin-top: 30px;
      border-top: 1px solid var(--light-green);
      padding-top: 20px;
    }
    
    .add-source-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .form-group label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 10px;
      background-color: rgba(0,0,0,0.2);
      border: 1px solid var(--light-green);
      border-radius: 4px;
      color: var(--text);
      font-family: 'Consolas', monospace;
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      border-color: var(--accent);
      outline: none;
    }
    
    .template-help {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-top: 3px;
    }
    
    .btn-add-source {
      padding: 10px;
      background-color: var(--light-green);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
      margin-top: 10px;
      align-self: flex-start;
    }
    
    .btn-add-source:hover {
      background-color: var(--accent);
    }
    
    .save-settings {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    
    .save-settings:hover {
      background-color: #3e8e41;
    }
    
    .reset-settings {
      margin-left: 10px;
      padding: 10px 15px;
      background-color: #777;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    
    .reset-settings:hover {
      background-color: #555;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--accent);
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 10000;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .custom-proxy-label {
      display: inline-flex;
      align-items: center;
      background-color: #2d664680;
      border-radius: 4px;
      padding: 2px 6px;
      margin-left: 8px;
      font-size: 0.7rem;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div id="landing">
    <h1><i class="fas fa-globe"></i> Web Navigator</h1>
    <p class="subtitle">Browse the web</p>
    
    <div class="input-container">
      <input type="text" id="url-input" placeholder="Where to? (e.g. example.com)" autofocus 
        onkeydown="if(event.key==='Enter') processUrl()">
      <button class="go-btn" onclick="processUrl()">GO</button>
    </div>

    <div class="settings-container">
      <button class="settings-btn" onclick="toggleSourcesModal()">
        <i class="fas fa-cog"></i> Manage Sources
      </button>
    </div>
    
    <div id="option-container" class="option-container">
      <p>What type of content?</p>
      <div class="options">
        <div class="option-box" onclick="loadWithPreference('news')">
          <i class="fas fa-newspaper"></i>
          <h3>News and Articles</h3>
        </div>
        <div class="option-box" onclick="loadWithPreference('gaming')">
          <i class="fas fa-gamepad"></i>
          <h3>Gaming</h3>
        </div>
        <div class="option-box" onclick="loadWithPreference('general')">
          <i class="fas fa-globe-americas"></i>
          <h3>General Use</h3>
        </div>
      </div>
    </div>
  </div>
  
  <footer id="footer">
    Made by 
    <a href="https://github.com/Zynk-dot" target="_blank">zynk-dot</a> and 
    <a href="https://github.com/thecooldoggo" target="_blank">thecooldoggo</a>
  </footer>
  
  <div id="loading-screen">
    <div class="loader"></div>
    <p id="loading-text">Loading content...</p>
    <p class="loading-info">If this takes too long, try another method</p>
    <button class="next-method-btn" onclick="switchMethod()">Try Next Method</button>
  </div>
  
  <div id="content-view"></div>
  
  <div class="method-switch-area">
    <div id="method-switch">
      <i class="fas fa-cog corner-icon"></i>
      <div class="switch-box">
        <button class="switch-btn" onclick="switchMethod()">Try next method</button>
        <p class="method-label" id="method-label">Current: Direct Method</p>
      </div>
    </div>
  </div>
  
  <div class="back-btn-area">
    <button id="back-btn" onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>
  </div>

  <div id="sources-modal" class="sources-modal">
    <div class="sources-container">
      <div class="sources-header">
        <h2>Manage Proxy Sources</h2>
        <button class="sources-close" onclick="toggleSourcesModal()">&times;</button>
      </div>
      
      <div id="sources-list">
        <!-- Sources will be dynamically populated here -->
      </div>
      
      <div class="add-source-section">
        <h3>Add Custom Proxy Source</h3>
        <div class="add-source-form">
          <div class="form-group">
            <label for="source-name">Name</label>
            <input type="text" id="source-name" placeholder="e.g. My Custom Proxy">
          </div>
          
          <div class="form-group">
            <label for="source-description">Description</label>
            <textarea id="source-description" rows="2" placeholder="Brief description of this proxy service"></textarea>
          </div>
          
          <div class="form-group">
            <label for="source-url-template">URL Template</label>
            <input type="text" id="source-url-template" placeholder="e.g. https://myproxy.com/${url}">
            <p class="template-help">Use ${url} as a placeholder for the target URL</p>
          </div>
          
          <div class="form-group">
            <label for="source-speed">Estimated Speed</label>
            <select id="source-speed">
              <option value="fast">Fast</option>
              <option value="medium" selected>Medium</option>
              <option value="slow">Slow</option>
            </select>
          </div>
          
          <button class="btn-add-source" onclick="addCustomSource()">Add Source</button>
        </div>
      </div>
      
      <div style="margin-top: 20px; text-align: center;">
        <button class="save-settings" onclick="saveSettings()">Save Settings</button>
        <button class="reset-settings" onclick="resetSettings()">Reset to Default</button>
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification"></div>

  <script>
    let currentUrl = '';
    let currentMethod = '';
    let contentType = '';
    let methodsFailed = { method1: false, method2: false, method3: false, method4: false };
    let isCurrentlyLoading = false;
    let attemptingLoad = false;
    
    // Default proxy sources configuration
    let proxySources = [
      {
        id: 'direct',
        name: 'Direct Method',
        description: 'Attempts to load the website directly in an embedded frame. Fastest method but may not work for sites that block embedding.',
        urlTemplate: '{direct}',
        speed: 'fast',
        enabled: true,
        isDefault: true,
        method: 'method1'
      },
      {
        id: 'allorigins',
        name: 'AllOrigins API',
        description: 'Uses a CORS proxy to fetch website content. Good for text-based sites but may have limitations with complex websites.',
        urlTemplate: '{proxy}',
        speed: 'medium',
        enabled: true,
        isDefault: true,
        method: 'method2'
      },
      {
        id: 'archive',
        name: 'Wayback Machine',
        description: 'Loads the most recent archived version of the website from the Internet Archive. Useful for sites that block other proxy methods.',
        urlTemplate: 'https://web.archive.org/web/2/${url}',
        speed: 'slow',
        enabled: true,
        isDefault: true,
        method: 'method3'
      },
      {
        id: '12ft',
        name: '12ft.io',
        description: 'Removes paywalls and bypasses site restrictions. Works well for news sites and articles behind subscription walls.',
        urlTemplate: 'https://12ft.io/${url}',
        speed: 'medium',
        enabled: true,
        isDefault: true,
        method: 'method4_0'
      },
      {
        id: 'archive-today',
        name: 'Archive.today',
        description: 'Web archiving service that takes snapshots of websites. Good for preserving content that might disappear.',
        urlTemplate: 'https://archive.today/${url}',
        speed: 'slow',
        enabled: true,
        isDefault: true,
        method: 'method4_2'
      }
    ];
    
    // Load saved settings from cookies
    loadSettings();
    
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the sources list
      renderSourcesList();
      
      // Setup method switch behavior
      const methodSwitch = document.getElementById('method-switch');
      const switchBox = methodSwitch.querySelector('.switch-box');
      
      // Settings icon click handler - toggle dropdown
      methodSwitch.addEventListener('click', function(e) {
        // Don't toggle if clicking inside the dropdown
        if (e.target.closest('.switch-box')) return;
        
        methodSwitch.classList.toggle('show-dropdown');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#method-switch')) {
          methodSwitch.classList.remove('show-dropdown');
        }
      });
      
      // When content is loaded, make sure settings icon appears when hovered
      document.addEventListener('mousemove', function(e) {
        const methodSwitchArea = document.querySelector('.method-switch-area');
        if (!methodSwitchArea) return;
        
        const rect = methodSwitchArea.getBoundingClientRect();
        if (e.clientX >= rect.left && e.clientX <= rect.right && 
            e.clientY >= rect.top && e.clientY <= rect.bottom) {
          methodSwitch.style.opacity = '0.7';
        } else if (!methodSwitch.classList.contains('show-dropdown')) {
          methodSwitch.style.opacity = '';
        }
      });
    });
    
    function processUrl() {
      const input = document.getElementById('url-input').value.trim();
      if (!input) return;
      
      currentUrl = input;
      if (!/^https?:\/\//i.test(currentUrl)) {
        currentUrl = 'https://' + currentUrl.replace(/^\/+/, '');
      }
      
      document.getElementById('option-container').style.display = 'flex';
      document.querySelector('.option-container').scrollIntoView({ behavior: 'smooth' });
    }
    
    function loadWithPreference(type) {
      contentType = type;
      methodsFailed = { method1: false, method2: false, method3: false, method4: false };
      
      showLoading();
      
      document.getElementById('landing').style.display = 'none';
      document.getElementById('footer').style.display = 'none';
      document.querySelector('.back-btn-area').style.display = 'block';
      document.getElementById('method-switch').style.opacity = '0';
      
      // Get first enabled method
      const firstEnabledSource = proxySources.find(source => source.enabled);
      if (firstEnabledSource) {
        const methodName = firstEnabledSource.method.split('_')[0]; // Extract base method name
        switch(methodName) {
          case 'method1': loadWithMethod1(); break;
          case 'method2': loadWithMethod2(); break;
          case 'method3': loadWithMethod3(); break;
          case 'method4': loadWithMethod4(); break;
          default: loadWithMethod1(); // Fallback
        }
      } else {
        // If no methods are enabled, show error
        handleAllMethodsFailed();
      }
    }
    
    function showLoading() {
      const loadingScreen = document.getElementById('loading-screen');
      loadingScreen.style.display = 'flex';
      isCurrentlyLoading = true;
      
      // Enable "Try Next Method" button
      document.querySelector('.next-method-btn').disabled = false;
    }
    
    function hideLoading() {
      const loadingScreen = document.getElementById('loading-screen');
      loadingScreen.style.display = 'none';
      isCurrentlyLoading = false;
      attemptingLoad = false;
    }
    
    function handleMethodFailure(method) {
      if (attemptingLoad) {
        console.log(`${method} failed, setting failure flag`);
        methodsFailed[method] = true;
        attemptingLoad = false;
        
        // Try next enabled method in sequence
        switchMethod(true);
      }
    }
    
    function loadWithMethod1(keepDropdownVisible = false) {
      attemptingLoad = true;
      currentMethod = 'method1';
      document.getElementById('loading-text').innerText = 'Loading via direct method...';
      document.getElementById('method-label').innerText = 'Current: Direct Method';
      showLoading();
      
      if (!keepDropdownVisible) {
        document.getElementById('method-switch').classList.remove('show-dropdown');
      }
      
      // Check if this method is enabled
      const directSource = proxySources.find(s => s.method === 'method1');
      if (!directSource || !directSource.enabled) {
        console.log("Direct method disabled, skipping");
        handleMethodFailure('method1');
        return;
      }
      
      try {
        const contentView = document.getElementById('content-view');
        contentView.innerHTML = '';
        contentView.style.display = 'block';
        
        const obj = document.createElement('object');
        obj.data = currentUrl;
        obj.width = '100%';
        obj.height = '100%';
        obj.style.border = 'none';
        obj.id = 'direct-object';
        
        let loadTimeout = setTimeout(() => {
          if (attemptingLoad) {
            handleMethodFailure('method1');
          }
        }, 12000);
        
        obj.onload = function() {
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            
            // Check if content actually loaded
            setTimeout(() => {
              try {
                const objDoc = obj.contentDocument || obj.contentWindow?.document;
                if (objDoc && objDoc.body && objDoc.body.innerHTML.length > 100) {
                  hideLoading();
                  console.log("Direct method loaded successfully");
                } else {
                  handleMethodFailure('method1');
                }
              } catch (e) {
                // Cross-origin restrictions mean we can't check content
                // Assume success if we got this far
                hideLoading();
                console.log("Direct method loaded but can't check content (cross-origin)");
              }
            }, 1000);
          }
        };
        
        obj.onerror = function() {
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            handleMethodFailure('method1');
          }
        };
        
        contentView.appendChild(obj);
      } catch (error) {
        console.error("Error in method 1:", error);
        handleMethodFailure('method1');
      }
    }
    
    function loadWithMethod2(keepDropdownVisible = false) {
      attemptingLoad = true;
      currentMethod = 'method2';
      document.getElementById('loading-text').innerText = 'Loading via proxy method...';
      document.getElementById('method-label').innerText = 'Current: Proxy API';
      showLoading();
      
      if (!keepDropdownVisible) {
        document.getElementById('method-switch').classList.remove('show-dropdown');
      }
      
      // Check if this method is enabled
      const proxySource = proxySources.find(s => s.method === 'method2');
      if (!proxySource || !proxySource.enabled) {
        console.log("Proxy API method disabled, skipping");
        handleMethodFailure('method2');
        return;
      }
      
      try {
        const contentView = document.getElementById('content-view');
        contentView.innerHTML = '';
        contentView.style.display = 'block';
        
        const iframe = document.createElement('iframe');
        iframe.id = 'contentFrame';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        contentView.appendChild(iframe);
        
        let loadTimeout = setTimeout(() => {
          if (attemptingLoad) {
            handleMethodFailure('method2');
          }
        }, 15000);
        
        fetchViaProxy(currentUrl).then(html => {
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            
            if (!html || html.length < 100) {
              console.log("Proxy returned empty or minimal content");
              handleMethodFailure('method2');
              return;
            }
            
            const baseHref = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
            html = html.replace(/<head.*?>/i, match => match + '<base href="' + baseHref + '">');
            
            html = html.replace('</body>', `
              <script>
                document.body.addEventListener('click', function(event) {
                  let target = event.target;
                  while (target && target.tagName !== 'A') target = target.parentElement;
                  if (target && target.href) {
                    event.preventDefault();
                    parent.postMessage({ type: 'stealth-navigate', url: target.href }, '*');
                  }
                });
              <\/script></body>`);
            
            const iframe = document.getElementById('contentFrame');
            if (iframe) {
              iframe.onload = function() {
                hideLoading();
                console.log("Proxy method loaded successfully");
              };
              
              iframe.srcdoc = html;
              
              // Fallback in case onload doesn't fire
              setTimeout(() => {
                if (attemptingLoad) {
                  hideLoading();
                  console.log("Proxy method: fallback timer triggered");
                }
              }, 3000);
            }
          }
        }).catch(error => {
          console.error("Error in proxy method:", error);
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            handleMethodFailure('method2');
          }
        });
      } catch (error) {
        console.error("Error setting up method 2:", error);
        handleMethodFailure('method2');
      }
    }
    
    function loadWithMethod3(keepDropdownVisible = false) {
      attemptingLoad = true;
      currentMethod = 'method3';
      document.getElementById('loading-text').innerText = 'Loading via archive method...';
      document.getElementById('method-label').innerText = 'Current: Archive';
      showLoading();
      
      if (!keepDropdownVisible) {
        document.getElementById('method-switch').classList.remove('show-dropdown');
      }
      
      // Check if this method is enabled
      const archiveSource = proxySources.find(s => s.method === 'method3');
      if (!archiveSource || !archiveSource.enabled) {
        console.log("Archive method disabled, skipping");
        handleMethodFailure('method3');
        return;
      }
      
      try {
        const contentView = document.getElementById('content-view');
        contentView.innerHTML = '';
        contentView.style.display = 'block';
        
        const obj = document.createElement('object');
        const archiveUrl = archiveSource.urlTemplate.replace('${url}', currentUrl);
        obj.data = archiveUrl;
        obj.width = '100%';
        obj.height = '100%';
        obj.style.border = 'none';
        obj.id = 'archive-object';
        
        let loadTimeout = setTimeout(() => {
          if (attemptingLoad) {
            handleMethodFailure('method3');
          }
        }, 15000);
        
        obj.onload = function() {
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            setTimeout(() => {
              try {
                // Try to check if content loaded
                const objDoc = obj.contentDocument || obj.contentWindow?.document;
                if (objDoc && objDoc.body && objDoc.body.innerHTML.length > 100) {
                  hideLoading();
                  console.log("Archive method loaded successfully");
                } else {
                  handleMethodFailure('method3');
                }
              } catch (e) {
                // Cross-origin - assume it worked
                hideLoading();
                console.log("Archive method loaded but can't check content (cross-origin)");
              }
            }, 2000);
          }
        };
        
        obj.onerror = function() {
          if (attemptingLoad) {
            clearTimeout(loadTimeout);
            handleMethodFailure('method3');
          }
        };
        
        contentView.appendChild(obj);
      } catch (error) {
        console.error("Error in archive method:", error);
        handleMethodFailure('method3');
      }
    }

    function loadWithMethod4(keepDropdownVisible = false) {
      attemptingLoad = true;
      currentMethod = 'method4';
      document.getElementById('loading-text').innerText = 'Loading via advanced proxy...';
      document.getElementById('method-label').innerText = 'Current: Advanced Proxy';
      showLoading();
      
      if (!keepDropdownVisible) {
        document.getElementById('method-switch').classList.remove('show-dropdown');
      }
      
      // Get enabled method4 sources
      const method4Sources = proxySources.filter(s => 
        s.method.startsWith('method4_') && s.enabled
      );
      
      if (method4Sources.length === 0) {
        console.log("No advanced proxy methods enabled, skipping");
        handleMethodFailure('method4');
        return;
      }
      
      function tryNextProxy(index) {
        if (index >= method4Sources.length) {
          methodsFailed.method4 = true;
          handleAllMethodsFailed();
          return;
        }
        
        const proxy = method4Sources[index];
        document.getElementById('loading-text').innerText = `Loading via ${proxy.name}...`;
        document.getElementById('method-label').innerText = `Current: ${proxy.name}`;
        
        try {
          const contentView = document.getElementById('content-view');
          contentView.innerHTML = '';
          contentView.style.display = 'block';
          
          const obj = document.createElement('iframe');
          obj.src = proxy.urlTemplate.replace('${url}', currentUrl);
          obj.width = '100%';
          obj.height = '100%';
          obj.style.border = 'none';
          obj.id = 'proxy-object';
          
          let hasLoaded = false;
          let loadTimeout = setTimeout(() => {
            if (!hasLoaded && attemptingLoad) {
              console.log(`${proxy.name} timed out, trying next proxy`);
              tryNextProxy(index + 1);
            }
          }, 15000);
          
          obj.onload = function() {
            if (attemptingLoad) {
              hasLoaded = true;
              clearTimeout(loadTimeout);
              
              // Give it a moment to fully render
              setTimeout(() => {
                hideLoading();
                console.log(`Successfully loaded via ${proxy.name}`);
              }, 1000);
            }
          };
          
          obj.onerror = function(e) {
            if (attemptingLoad && !hasLoaded) {
              console.error(`Error with ${proxy.name}:`, e);
              clearTimeout(loadTimeout);
              console.log(`${proxy.name} failed, trying next proxy`);
              tryNextProxy(index + 1);
            }
          };
          
          // Content check fallback
          setTimeout(() => {
            if (document.getElementById('proxy-object') === obj && !hasLoaded && attemptingLoad) {
              try {
                // For iframes, we can sometimes detect load this way
                if (obj.contentWindow && obj.contentWindow.document) {
                  hasLoaded = true;
                  clearTimeout(loadTimeout);
                  hideLoading();
                  console.log(`Successfully loaded via ${proxy.name} (content check)`);
                }
              } catch (e) {
                // Cross-origin restrictions - assume it worked if it hasn't errored yet
                hasLoaded = true;
                clearTimeout(loadTimeout);
                hideLoading();
                console.log(`Successfully loaded via ${proxy.name} (cross-origin)`);
              }
            }
          }, 8000);
          
          contentView.appendChild(obj);
        } catch (error) {
          console.error(`Error setting up ${proxy.name}:`, error);
          if (attemptingLoad) {
            tryNextProxy(index + 1);
          }
        }
      }
      
      tryNextProxy(0);
    }
    
    async function fetchViaProxy(url) {
      const proxy = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
      const response = await fetch(proxy);
      if (!response.ok) throw new Error("Proxy failed with status " + response.status);
      const json = await response.json();
      return json.contents;
    }
    
    function handleAllMethodsFailed() {
      hideLoading();
      const contentView = document.getElementById('content-view');
      contentView.innerHTML = `
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; background-color: var(--dark-bg); color: var(--text);">
          <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #ff9800; margin-bottom: 20px;"></i>
          <h2>Unable to Load Content</h2>
          <p>All proxy methods failed to load the requested page.</p>
          <p>URL: <code style="background: rgba(255,255,255,0.1); padding: 5px; border-radius: 3px;">${currentUrl}</code></p>
          <button onclick="goBack()" style="margin-top: 20px; padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer;">
            Return to Home
          </button>
        </div>
      `;
    }
    
    function switchMethod(fromFailure = false) {
      // Keep dropdown visible if user manually clicked
      const keepDropdownVisible = !fromFailure;
      
      // Cancel current load attempt
      attemptingLoad = false;
      
      // Find next enabled method
      const methods = ['method1', 'method2', 'method3', 'method4'];
      const currentIndex = methods.indexOf(currentMethod.split('_')[0]); // handle method4_x format
      
      // If we're switching due to failure, start from current index + 1
      // If user manually requested, start from current index + 1, and wrap around
      let nextIndex = (currentIndex + 1) % methods.length;
      let startIndex = nextIndex;
      let foundMethod = false;
      
      do {
        const method = methods[nextIndex];
        // For method4, check if any submethod is enabled
        if (method === 'method4') {
          const method4Sources = proxySources.filter(s => 
            s.method.startsWith('method4_') && s.enabled
          );
          if (method4Sources.length > 0) {
            loadWithMethod4(keepDropdownVisible);
            foundMethod = true;
            break;
          }
        } else {
          // For other methods, check if that specific method is enabled
          const source = proxySources.find(s => s.method === method && s.enabled);
          if (source) {
            switch(method) {
              case 'method1': loadWithMethod1(keepDropdownVisible); break;
              case 'method2': loadWithMethod2(keepDropdownVisible); break;
              case 'method3': loadWithMethod3(keepDropdownVisible); break;
            }
            foundMethod = true;
            break;
          }
        }
        
        nextIndex = (nextIndex + 1) % methods.length;
      } while (nextIndex !== startIndex);
      
      if (!foundMethod) {
        // If from failure and no more methods, show error
        if (fromFailure) {
          handleAllMethodsFailed();
        } else {
          // If manual switch and no other methods, show notification
          showNotification("No other enabled methods available");
        }
      }
    }
    
    function goBack() {
      document.getElementById('landing').style.display = 'flex';
      document.getElementById('footer').style.display = 'block';
      document.getElementById('content-view').style.display = 'none';
      document.querySelector('.back-btn-area').style.display = 'none';
      document.getElementById('url-input').value = '';
      document.getElementById('option-container').style.display = 'none';
      document.getElementById('method-switch').style.opacity = '0';
      document.getElementById('method-switch').classList.remove('show-dropdown');
      hideLoading();
      
      methodsFailed = { method1: false, method2: false, method3: false, method4: false };
      currentUrl = '';
      currentMethod = '';
    }
    
    window.addEventListener('message', (e) => {
      if (e.data?.type === 'stealth-navigate' && typeof e.data.url === 'string') {
        currentUrl = e.data.url;
        showLoading();
        attemptingLoad = true;
        
        if (currentMethod === 'method1') {
          loadWithMethod1();
        } else if (currentMethod === 'method2') {
          loadWithMethod2();
        } else if (currentMethod === 'method3') {
          loadWithMethod3();
        } else if (currentMethod.startsWith('method4')) {
          loadWithMethod4();
        } else {
          if (contentType === 'general') {
            loadWithMethod2();
          } else {
            loadWithMethod1();
          }
        }
      }
    });
    
    // Sources management functions
    function toggleSourcesModal() {
      const modal = document.getElementById('sources-modal');
      modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
      
      // Re-render the sources list when opening
      if (modal.style.display === 'flex') {
        renderSourcesList();
      }
    }
    
    function renderSourcesList() {
      const sourcesList = document.getElementById('sources-list');
      sourcesList.innerHTML = '';
      
      proxySources.forEach(source => {
        const sourceItem = document.createElement('div');
        sourceItem.className = 'source-item';
        
        const speedClass = source.speed === 'fast' ? 'speed-fast' : 
                          source.speed === 'medium' ? 'speed-medium' : 'speed-slow';
        
        // Determine if this is a custom source
        const isCustom = !source.isDefault;
        
        sourceItem.innerHTML = `
          <div class="source-header">
            <h3 class="source-title">
              ${source.name}
              ${isCustom ? `<span class="custom-proxy-label">Custom</span>` : ''}
            </h3>
            <label class="source-toggle">
              <input type="checkbox" ${source.enabled ? 'checked' : ''} 
                onchange="toggleSource('${source.id}', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
          <div class="source-speed ${speedClass}">
            Speed: 
            <span class="speed-dot"></span>
            <span class="speed-dot"></span>
            <span class="speed-dot"></span>
          </div>
          <p class="source-description">${source.description}</p>
          ${isCustom ? `
            <button class="switch-btn" onclick="removeCustomSource('${source.id}')" 
              style="background-color: #d32f2f; margin-top: 10px;">
              <i class="fas fa-trash"></i> Remove
            </button>
          ` : ''}
        `;
        
        sourcesList.appendChild(sourceItem);
      });
    }
    
    function toggleSource(sourceId, enabled) {
      const source = proxySources.find(s => s.id === sourceId);
      if (source) {
        source.enabled = enabled;
      }
    }
    
    function addCustomSource() {
      const name = document.getElementById('source-name').value.trim();
      const description = document.getElementById('source-description').value.trim();
      const urlTemplate = document.getElementById('source-url-template').value.trim();
      const speed = document.getElementById('source-speed').value;
      
      if (!name || !urlTemplate) {
        showNotification("Please provide a name and URL template");
        return;
      }
      
      if (!urlTemplate.includes('${url}')) {
        showNotification("URL template must contain ${url} placeholder");
        return;
      }
      
      // Generate a unique ID
      const id = 'custom_' + Date.now();
      
      // Find the highest method4 index
      const method4Sources = proxySources.filter(s => s.method.startsWith('method4_'));
      let highestIndex = -1;
      method4Sources.forEach(s => {
        const index = parseInt(s.method.split('_')[1]);
        if (!isNaN(index) && index > highestIndex) {
          highestIndex = index;
        }
      });
      
      const newMethod = `method4_${highestIndex + 1}`;
      
      const newSource = {
        id,
        name,
        description: description || `Custom proxy service using ${urlTemplate}`,
        urlTemplate,
        speed,
        enabled: true,
        isDefault: false,
        method: newMethod
      };
      
      proxySources.push(newSource);
      renderSourcesList();
      
      // Clear form
      document.getElementById('source-name').value = '';
      document.getElementById('source-description').value = '';
      document.getElementById('source-url-template').value = '';
      document.getElementById('source-speed').value = 'medium';
      
      showNotification("Custom source added successfully");
    }
    
    function removeCustomSource(sourceId) {
      const index = proxySources.findIndex(s => s.id === sourceId);
      if (index !== -1 && !proxySources[index].isDefault) {
        proxySources.splice(index, 1);
        renderSourcesList();
        showNotification("Custom source removed");
      }
    }
    
    function saveSettings() {
      // Save to cookie
      const sourceSettings = {
        sources: proxySources,
        lastUpdated: new Date().toISOString()
      };
      
      // Set cookie to expire in 365 days
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + 365);
      
      document.cookie = `webNavigatorSettings=${encodeURIComponent(JSON.stringify(sourceSettings))};expires=${expiryDate.toUTCString()};path=/;SameSite=Lax`;
      
      showNotification("Settings saved successfully");
      toggleSourcesModal();
    }
    
    function resetSettings() {
      if (confirm("Reset all sources to default settings?")) {
        // Reset to default sources
        proxySources = [
          {
            id: 'direct',
            name: 'Direct Method',
            description: 'Attempts to load the website directly in an embedded frame. Fastest method but may not work for sites that block embedding.',
            urlTemplate: '{direct}',
            speed: 'fast',
            enabled: true,
            isDefault: true,
            method: 'method1'
          },
          {
            id: 'allorigins',
            name: 'AllOrigins API',
            description: 'Uses a CORS proxy to fetch website content. Good for text-based sites but may have limitations with complex websites.',
            urlTemplate: '{proxy}',
            speed: 'medium',
            enabled: true,
            isDefault: true,
            method: 'method2'
          },
          {
            id: 'archive',
            name: 'Wayback Machine',
            description: 'Loads the most recent archived version of the website from the Internet Archive. Useful for sites that block other proxy methods.',
            urlTemplate: 'https://web.archive.org/web/2/${url}',
            speed: 'slow',
            enabled: true,
            isDefault: true,
            method: 'method3'
          },
          {
            id: '12ft',
            name: '12ft.io',
            description: 'Removes paywalls and bypasses site restrictions. Works well for news sites and articles behind subscription walls.',
            urlTemplate: 'https://12ft.io/${url}',
            speed: 'medium',
            enabled: true,
            isDefault: true,
            method: 'method4_0'
          },
          {
            id: 'archive-today',
            name: 'Archive.today',
            description: 'Web archiving service that takes snapshots of websites. Good for preserving content that might disappear.',
            urlTemplate: 'https://archive.today/${url}',
            speed: 'slow',
            enabled: true,
            isDefault: true,
            method: 'method4_2'
          }
        ];
        
        // Clear cookie
        document.cookie = "webNavigatorSettings=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;";
        
        renderSourcesList();
        showNotification("Settings reset to default");
      }
    }
    
    function loadSettings() {
      // Try to load from cookie
      const cookieMatch = document.cookie.match(/webNavigatorSettings=([^;]+)/);
      if (cookieMatch) {
        try {
          const savedSettings = JSON.parse(decodeURIComponent(cookieMatch[1]));
          if (savedSettings && Array.isArray(savedSettings.sources)) {
            proxySources = savedSettings.sources;
            console.log("Loaded sources from cookie:", proxySources.length);
          }
        } catch (e) {
          console.error("Error parsing saved settings:", e);
        }
      }
    }
    
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
